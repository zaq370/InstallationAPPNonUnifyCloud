@model InstallationAPPNonUnify.Areas.CMS.ViewModels.LanguageSettingViewModel

@{
    Layout = "~/Areas/CMS/Views/Shared/_CMSLayout.cshtml";
}

<script>
    var modelMessage = '@Html.Raw(Model.Message)';
    var fieldDisplayName = @Html.Raw(Json.Encode(Model.FieldDispalyName));
    var alertMessageFromModel = "@Html.Raw(Model.AlertMessage)";
    var IsSuperUser = ('@ViewBag.IsSuperUser' == 'True');
    (function () {
        try {
            if (alertMessageFromModel != null && alertMessageFromModel != "")
                alert(alertMessageFromModel);
        } catch (e) { }
    })();
    document.getElementById("LanguageSettingNavbar").parentElement.classList.add("active");
</script>

<input type="text" id="fieldFilter" class="searchInput w70" onkeyup="fieldFilter()" placeholder=@ViewBag.Search>

@using (Html.BeginForm("LanguageSetting", "Main", FormMethod.Post, new { @class = "validationForm" }))
{
    @Html.Hidden("NewList")
    @Html.Hidden("PickeLanguage")
    <table class="table table-striped table-block" id="LanguageSettingTable">
        <thead>
            <tr class="fixed-table-header">
                <th style="width:15%">
                    <input type="submit" value='@ViewBag.Apply' class="submit-form btn btn-danger" onclick="FormSubmit()">
                </th>
                @for (var i = 0; i < Model.SelectCountries.Count(); i++ )
                {
                    var languageIndex = "Language" + (i+1);
                    <th class="block countryCode" data-content='@Model.SelectCountries.ElementAt(i).Key' data-language-index='@languageIndex'>
                        @Html.DisplayFor(item => Model.SelectCountries.ElementAt(i).Value)
                    </th>
                }
            </tr>
        </thead>
        
        @foreach (var field in Model.Ids) { 
            <tr class="body-content">
                <td class="fieldId" data-content='@field' style="font-size:small; word-break:break-all;">
                    @field
                    <input style="display:block" type="button" value='@ViewBag.Undo' onclick="reverse(this)" class="submit-form btn btn-warning">
                </td>
                <td class="block fieldDesc" onkeyup="checkIsModified(this)" data-content='@Model.Pack1.Content.Where(item => item.FieldId.Equals(field)).FirstOrDefault().FieldDesc.Replace("\\'", "'")'>
                    @Html.TextBox("Language1", Model.Pack1.Content.Where(item => item.FieldId.Equals(field)).FirstOrDefault().FieldDesc.Replace("\\'","'"))
                </td>
                @if (Model.SelectCountries.Count > 1)
                {
                    <td class="block fieldDesc" onkeyup="checkIsModified(this)" data-content='@Model.Pack2.Content.Where(item => item.FieldId.Equals(field)).FirstOrDefault().FieldDesc.Replace("\\'", "'")'>
                        @Html.TextBox("Language2", Model.Pack2.Content.Where(item => item.FieldId.Equals(field)).FirstOrDefault().FieldDesc.Replace("\\'", "'"))
                    </td>
                }
            </tr>
        }
    </table>
}

<script>
    $(document).ready(function () {
        $("#LanguageSettingTable").find(".body-content").find("td").each(function () {
            //add tool tip
            if ($(this).hasClass("fieldDesc")) {
                var content = Common.UnescapeHTML($(this).data("content"));
                $(this).find("input[type=text]").val(content);
                $(this).data("content", content);
                $(this).prop("title", "Original is: " + content);
            }
            //如果是Reverse的先隱藏
            if ($(this).hasClass("fieldId"))
                $(this).find("input[type=button]").css("display","none");
        });

        $(document).find("input[type=text]").on("change keyup", function () {
            $(this).val(Common.AcceptChar($(this).val()));
        })
        
        //如果語系中有en-us(英文)，先不予以修改
        $("#LanguageSettingTable").find("th.countryCode").each(function () {
            if ($(this).data("content").toLowerCase() == "en-us") {
                var languageIndex = $(this).data("languageIndex");
                $("#LanguageSettingTable").find("input#" + languageIndex).attr("disabled", true);
            }
        });
    });

    function checkIsModified(element) {
        var input = $(element).find("input[type=text]");
        if (!input) return;

        if ($(element).data("content") != input.val()) {
            if (!input.hasClass("modofied")) {
                input.addClass("modified");
                $(element).closest("tr").find("td.fieldId").find("input[type=button]").css("display", "block");
            }
        }
        else {
            input.removeClass("modified");
            $(element).closest("tr").find("td.fieldId").find("input[type=button]").css("display", "none");
        }
    }

    function reverse(element) {
        $(element).closest("tr").find("td").each(function () {
            if ($(this).data("content")) {
                $(this).find("input[type=text]").val($(this).data("content")).removeClass("modified");
            }

            if ($(this).hasClass("fieldId"))
                $(this).find("input[type=button]").css("display", "none");
        });
    }

    function fieldFilter() {
        var input = $("#fieldFilter").val().toLowerCase();
        var table = $("#LanguageSettingTable");
        var tr = table.find(".body-content");

        for (var i = 0 ; i < tr.length ; i++) {
            var isContains = false;

            if ($(tr[i]).find(".fieldId").text().toLowerCase().indexOf(input) >= 0)
                isContains = true;

            if ($(tr[i]).find("input[type=text]").each(function () {
                var test = $(this).val().toLowerCase();
                if ($(this).val().toLowerCase().indexOf(input) >= 0)
                    isContains = true;
            }));
                
            if (isContains)
                $(tr[i]).css("display", "");
            else
                $(tr[i]).css("display", "none");
        }
    }

    function FormSubmit() {

        var newLanguageList1 = {};
        var newLanguageList2 = {};

        
        $("#LanguageSettingTable").find(".body-content").each(function () {
            var id = $(this).find("td.fieldId").data("content");
            var languageElement1 = $(this).find("input#Language1").first();
            var languageElement2 = $(this).find("input#Language2").first();
            
            if (languageElement1.length > 0) {
                languageElement1.val(Common.EscapeHTML(languageElement1.val())); //修正特殊字元
                //有修改過的資料放入newLanguageList1
                if (languageElement1.hasClass("modified"))  
                    newLanguageList1[id] = languageElement1.val();
            }

            if (languageElement2.length > 0) {
                languageElement2.val(Common.EscapeHTML(languageElement2.val())); //修正特殊字元
                //有修改過的資料放入newLanguageList2
                if (languageElement2.hasClass("modified"))  
                    newLanguageList2[id] =  languageElement2.val();
            }

        });

        var index = 1, languagePack1 = {}, languagePack2 = {}, pickLanguage = [];
        $("#LanguageSettingTable").find("th.countryCode").each(function () {
            switch (index) {
                case index = 1:
                    languagePack1 = {
                        Language: $(this).data("content"),
                        Content: JSON.stringify(newLanguageList1)
                    };
                    pickLanguage.push($(this).data("content"));
                    break;
                case index = 2:
                    languagePack2 = {
                        Language: $(this).data("content"),
                        Content: JSON.stringify(newLanguageList2)
                    };
                    pickLanguage.push($(this).data("content"));
                    break;
            }
            index++;
        });
        var content = {
            Language1: JSON.stringify(languagePack1),
            Language2: JSON.stringify(languagePack2)
        };
        $("#NewList").val(JSON.stringify(content));
        $("#PickeLanguage").val(JSON.stringify(pickLanguage));
    }
</script>
